@startuml GridTokenX_DFD_Level_2_Authentication
!define FONT_NAME Arial
!define FONT_SIZE 9
!theme plain

skinparam {
    DefaultFontName FONT_NAME
    DefaultFontSize FONT_SIZE
    Padding 6
    Margin 6
    BackgroundColor white
    BorderColor #333333
    ArrowColor #333333
}

' Title
title DFD Level 2 - User Authentication & Registration Decomposition (Process 1.0)

' External Entities
oval "Users" as E1
oval "Blockchain" as E2
oval "API Clients" as E3

' Sub-processes of 1.0 User Authentication
rectangle "1.1\nWallet\nVerification" as P11 {
    backgroundColor #BBDEFB
    borderColor #0277BD
}

rectangle "1.2\nUser\nRegistration" as P12 {
    backgroundColor #BBDEFB
    borderColor #0277BD
}

rectangle "1.3\nCredential\nValidation" as P13 {
    backgroundColor #BBDEFB
    borderColor #0277BD
}

rectangle "1.4\nJWT Token\nGeneration" as P14 {
    backgroundColor #BBDEFB
    borderColor #0277BD
}

rectangle "1.5\nSession\nManagement" as P15 {
    backgroundColor #BBDEFB
    borderColor #0277BD
}

rectangle "1.6\nAuthorization\nCheck" as P16 {
    backgroundColor #BBDEFB
    borderColor #0277BD
}

' Data Stores
database "User\nAccounts" as D11
database "Auth\nTokens" as D12
database "Session\nData" as D13
database "User\nRoles" as D14

' Data Flows - Wallet Verification
E1 --> P11 : Wallet Address\nSignature
P11 --> E2 : Verify Wallet\nOn Blockchain
E2 --> P11 : Wallet\nValid
P11 --> D11 : Check\nRegistration

' User Registration
P11 --> P12 : Wallet\nConfirmed
E1 --> P12 : User Info\n(Name, Email)
P12 --> D11 : Create\nUser Account
D11 --> P12 : User ID\nGenerated

' Credential Validation
E3 --> P13 : Login\nCredentials
D11 --> P13 : Fetch User\nRecord
P13 --> P12 : Validate\nPassword
P13 --> D14 : Check\nRole

' JWT Token Generation
P13 --> P14 : Auth Valid
P14 --> D12 : Store\nToken
P14 --> E3 : JWT Token\nIssued
D14 --> P14 : Include\nRoles/Claims

' Session Management
P14 --> P15 : New\nSession
P15 --> D13 : Store\nSession Info
E3 --> P15 : Use Token\nInRequest
D13 --> P15 : Retrieve\nSession
P15 --> P16 : Session\nValid

' Authorization Check
P16 --> D14 : Check\nPermissions
D14 --> P16 : User\nRoles
P16 --> E3 : Authorization\nDecision

' Token Refresh
E3 --> P14 : Refresh\nToken Request
D12 --> P14 : Validate\nOld Token
P14 --> D12 : Revoke\nOld Token
P14 --> E3 : New Token\nIssued

' Session Termination
E3 --> P15 : Logout\nRequest
P15 --> D13 : Delete\nSession
D12 --> P15 : Revoke\nToken
P15 --> E3 : Logout\nConfirmed

@enduml
